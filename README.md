# open-foam-vortex
1. Создание однотипных вихрей по словарю
2. Расчет суммарных показателей вихря
3. Адаптивную сетку
4. Оптимизировать солвер с использованием CUDA (и возможно портировать на OpenCL
5. Скомпилировать эти решатели для разных операционных систем и аппаратной поддержки
6. Систему распределения задач по всем желающим помочь проекту

1. Создание однотипных вихрей по словарю
Можно воспользоваться утилитой funkySetFields из библиотеки swak4foam и сделать по аналогии. Пример желаемого словаря
/*--------------------------------*- C++ -*----------------------------------*\
| ========= | |
| \\ / F ield | OpenFOAM: The Open Source CFD Toolbox |
| \\ / O peration | Version: 4.1 |
| \\ / A nd | Web: www.OpenFOAM.org |
| \\/ M anipulation | |
\*---------------------------------------------------------------------------*/
FoamFile
{
version 2.0;
format ascii;
class dictionary;
location "system";
object setVortexDict;
}
// * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * //
// установка значений по умолчанию - заполнение "пустого" пространства
defaultFieldValues
(
volVectorFieldValue U (0 0 0)
volScalarFieldValue T 348.432
volScalarFieldValue p 100000000
);
// определение вихрей
vortexDefinition
{
// radius Rc, Rtor, ign
R (4 3.5 0)
// velocity Uc, Utor, ign
U (10 10 0)
fieldValues
(
volScalarFieldValue T 348.432
volScalarFieldValue p 100000000
)
};// список вихрей
vortices
(
vortex
{
// положение центра вихря
position (0 0 0)
// вектор скорости вихря
velocity (0 0 0)
// угол поворота вихря
angle (0 0 0)
}
);

2. Расчет суммарных показателей вихря
Утилита которая вычисляет ячейки принадлежащие вихрю. Требуется для вычисления суммарной энергии вихря, потери энергии, "массу" вихря и т.п.
Примерное (неоптимальное) решение:
известны центр вихря и поворот его плоскости на предыдущем шаге. можно для набора точек на этой плоскости внутри кольцевой оси тора построить трассировки движени виртуальной точки - и если точка возвращается в эту же плоскость - значит она пренадлежит вихрю и все ячейки которые пересекла данная точка считать принадлежащими вихрю
Проще сделать как утилиту постпроцесса - смотреть статистику постфактум.
В идиале если эти показатели будут расчитываться на GPU в цикле солвера можно будет использовать в условиях остановки

3. Адаптивную сетку
На гранях кубической сетки происходит большая потеря энергии вихря за счёт рассеивания. Если сетка будет состоять не из кубов а из тетраидеров и с ориентацией одной (или двух) граней в направлении потока и одной грани поперек потока - рассеивание снизится на порядок.
Также полезным будет делать мелкую ячейку в зонах с большими градиентами скоростей и давлений.
Перестроение кубической решётки можно подсмотреть у этого товарища: https://youtu.be/u-VV3euIsXo
Построение тетрагональной сетки можно найти в foam-extened-3.2
Идиально будет если сетка будет перестраиваться - на GPU

тут же можно сделать ещё одну утилиту: сжатие сетки для хранения и отображения средствами ParaView - для просмотра не нужны десятки миллионов ячеек - они здорово тормозят. Хорошо будет если расчет будет идти на подробной сетке, а для просмотра достаточно и более грубой картинки.

4. Оптимизировать солвер с использованием CUDA (и возможно портировать на OpenCL)
существующий солвер использует GPU как внешний плагин. Отсюда в каждом цикле идет копирование данных из хоста в девайс - которое и съедает все время. Требуется написать свой солвер который будет полностью находиться в GPU не копируя данные на хост без необходимости
Возможно надо пересмотреть алгоритмы. Родные CUDA солверы из foam-extended-3.2 не загружают мою видео карту даже на 1%

7. Добавить визуализацию в проект
7.1 визуализация препроцессора - графический интерфейс для расставления вихрей и направления их движений. Потом генерировать словарь из пункта 1.
7.2 визуализировать полученный результат - отображать данные которые хранятся в памяти GPU. Возможно можно как-то встроиться в ParaView для отображения результата или наоборот взать из ParaView методы отображения и использовать в своей программе.

Замечательная новость: добрые люди оптимизировали OpenFOAM под GPU (пункт 4) и выложили в сеть открытым доступом!
https://github.com/Atizar/RapidCFD-dev
https://sim-flow.com/rapid-cfd-gpu/
зы: скомпилировалось, но пока не могу запустить. Примеры из OpenFOAM не запускаются, чего то не хватает.
